local url = 'http://localhost:4343/'
local args = ''

server_on = http.get(url..'hello/')

if server_on == nil then
  print('PyServer is off')
  return
else
  print('PyServer ready')
end

function tableToString(tbl)
  str = '{'
  for k,v in pairs(tbl) do
    str = str..tostring(k)..':'
    if type(v) == 'table' then
      str = str..tableToString(v)
    else
      str = str..tostring(v)
    end
    str = str..','
  end
  str = str..'}'
  
  return str
end

function handler(src)
  if src then
    cmd_string = 'return '..src.readAll()
    cmd_result1, cmd_result2 = loadstring(cmd_string)()
    --print(cmd_string..' --> '..tostring(cmd_result1)..'&'..tostring(cmd_result2))
    
    query_string = 'result='..tostring(cmd_result1)
    if cmd_result2 then
      if type(cmd_result2) == 'table' then
        query_string = query_string..'&result2='..tableToString(cmd_result2)
      else
        query_string = query_string..'&result2='..tostring(cmd_result2)
      end
    end
    
    http.post(url..args, query_string)
  end
  args = ''
end

function errorhandler( err )
  http.post(url..args, 'error='..err)
  print('Error: '..err)
end

while true do
  local event = os.pullEvent()
  if event == 'key' then
    break
  end
  
  src = http.get(url..args)
  
  status = xpcall(handler, errorhandler, src)
  --if status then
    --print(status) 
  --end
end
